# Circular Dashboard – Clerk Orgs + Stripe Sandbox

[![Deployed on Vercel](https://img.shields.io/badge/Deployed%20on-Vercel-black?style=for-the-badge&logo=vercel)](https://vercel.com/focus-otters-projects/v0-circular-dashboard-design)

## What this project is

This is a Next.js app that showcases a dashboard experience with team-based access powered by Clerk Organizations and a Stripe-powered pricing and billing flow. It demonstrates how to:

- Authenticate users with Clerk and organize them into orgs/teams
- Sell plans using Stripe (Sandbox) and process webhooks to update org entitlements
- Provide a clean dashboard experience with routes like `app/dashboard`, billing, developer settings, and project detail pages

Key routes and components:

- `app/page.tsx`: Landing page powered by `components/landing-page.tsx`
- `app/dashboard/page.tsx`: Dashboard powered by `components/circular-dashboard.tsx`
- `app/api/stripe/route.ts`: Stripe webhook handler that maps price IDs to plans and updates Clerk org limits/metadata
- `app/api/clerk/route.ts`: Convenience endpoint to fetch the active org (includes member count)
- `app/sign-in/[[...sign-in]]/page.tsx`: Custom sign-in route used by Clerk
- `app/pricing/page.tsx`: Pricing page that pairs with Stripe Checkout/Pricing Table

## Architecture at a glance

- AuthN/AuthZ: Clerk (with Organizations). The app expects an active org context for dashboard actions.
- Billing: Stripe Sandbox. Checkout completion triggers a webhook to update the org’s plan and member limits.
- Webhooks: Next.js Route Handler at `app/api/stripe/route.ts`. It verifies signatures using `STRIPE_WEBHOOK_SECRET` and updates orgs via `@clerk/nextjs/server`.

## Required environment variables

Create a `.env.local` from `sample.env.local` and set the following. Where to get each value is listed below.

```bash
# Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=/dashboard
NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=/dashboard

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### Where to get these

- NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: Clerk Dashboard → Project → API Keys → Publishable key.
- CLERK_SECRET_KEY: Clerk Dashboard → Project → API Keys → Secret key.
- NEXT_PUBLIC_CLERK_SIGN_IN_URL: Usually `/sign-in` for the custom route at `app/sign-in/[[...sign-in]]/page.tsx`.
- NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL: Where users land after sign-in if no prior intent; commonly `/dashboard`.
- NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL: Where users land after sign-up; commonly `/dashboard` where they can join/create an org.
- STRIPE_SECRET_KEY: Stripe Dashboard → Developers → API keys → Secret key (use a test key in Sandbox).
- STRIPE_WEBHOOK_SECRET: Generated by Stripe CLI when you run `stripe listen` for your local webhook tunnel (see below).

## Clerk Organizations and custom routes

- Organizations provide a team context (org ID) used across the dashboard. The Stripe webhook reads the org ID from the Stripe Checkout `client_reference_id` and updates that org’s entitlements.
- Custom auth routes: The app uses a custom sign-in route at `app/sign-in/[[...sign-in]]/page.tsx`. Configure Clerk’s URLs via the `NEXT_PUBLIC_CLERK_*` variables above.

## Stripe Sandbox and Stripe CLI

This repo expects you to use Stripe’s Sandbox with the Stripe CLI for local webhook delivery.

1) Log in to Stripe CLI:

```bash
stripe login
```

2) Start a webhook tunnel to your Next.js route:

```bash
stripe listen --forward-to localhost:3000/api/stripe
```

The command prints a signing secret like `whsec_abc123` — copy that to `STRIPE_WEBHOOK_SECRET` in `.env.local`.

3) Trigger a test checkout from your Pricing page and complete it using test cards. The webhook handler at `app/api/stripe/route.ts` will:

- Verify the signature with `STRIPE_WEBHOOK_SECRET`
- Resolve the purchased `price` to a plan (by price ID)
- Update the Clerk organization’s `maxAllowedMemberships` and `privateMetadata` according to the plan

To test cancellations, you can emit or simulate the `customer.subscription.deleted` event; the handler resets org limits to defaults.

## Local development

```bash
pnpm install    # or npm install / yarn
pnpm dev        # or npm run dev / yarn dev
```

Then, in another terminal, run Stripe CLI `listen` as shown above.

## Deployment

This project is designed to deploy on Vercel. Set the same environment variables in your Vercel Project Settings. For Stripe webhooks in production, create a Production webhook endpoint in Stripe Dashboard that points to your deployed URL’s `/api/stripe` and set the production signing secret in your environment.

## Notes

- The Stripe webhook maps specific Stripe Price IDs to internal plans. Update the mapping in `app/api/stripe/route.ts` (`PLAN_BY_PRICE`) to match your Stripe catalog.
- The Clerk org fetch helper exists at `app/api/clerk/route.ts`.

---

If you’re exploring the code, good starting points are `app/page.tsx`, `app/dashboard/page.tsx`, `components/circular-dashboard.tsx`, `app/pricing/page.tsx`, and the webhook at `app/api/stripe/route.ts`.